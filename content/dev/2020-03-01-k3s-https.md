---
layout: post
title: "k3s ì‹œë¦¬ì¦ˆ - Kubernetesì—ì„œ ì‰½ê²Œ HTTPS ì›¹ ì„œë¹„ìŠ¤ ëŒë¦¬ê¸°"
date: 2020-03-01 17:29:00 +0900
category: dev
excerpt: "ì´ë²ˆ ê¸€ì—ì„œëŠ” Letâ€™s Encrypt ì¸ì¦ì„œë¥¼ ë°œê¸‰ë°›ê¸° ìœ„í•´ cert-managerë¥¼ ì„¤ì¹˜í•˜ê³ , ê°„ë‹¨í•œ ì›¹ ì„œë¹„ìŠ¤ë¥¼ ëŒë ¤ë³´ëŠ” ê³¼ì •ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤."
---

ì´ì „ ê¸€ì—ì„œëŠ” VPS ë“±ì˜ ì„œë²„ í™˜ê²½ì— ê°„ë‹¨í•˜ê²Œ k3s í´ëŸ¬ìŠ¤í„°ë¥¼ ì„¤ì¹˜í•˜ê³ , ì›ê²©ìœ¼ë¡œ ì ‘ì†í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤. í´ëŸ¬ìŠ¤í„°ë¥¼ ì„¤ì¹˜ë˜ì—ˆìœ¼ë©´ ë­ë¼ë„ ë°°í¬ë¥¼ í•´ ë³´ì•„ì•¼ê² ì£ ? ì´ë²ˆ ê¸€ì—ì„œëŠ” Letâ€™s Encrypt ì¸ì¦ì„œë¥¼ ë°œê¸‰ë°›ê¸° ìœ„í•´ [cert-manager](https://cert-manager.io)ë¥¼ ì„¤ì¹˜í•˜ê³ , ê°„ë‹¨í•œ ì›¹ ì„œë¹„ìŠ¤ë¥¼ ëŒë ¤ë³´ëŠ” ê³¼ì •ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

ì•ìœ¼ë¡œ ì§„í–‰í•  íŠœí† ë¦¬ì–¼ì€ k3s í´ëŸ¬ìŠ¤í„°ë¥¼ ì´ë¯¸ ìƒì„±í•˜ê³ , `kubectl`ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•œ ê²ƒì„ ê°€ì •í•©ë‹ˆë‹¤. í˜¹ì‹œ ì•„ì§ k3së¥¼ ì„¤ì¹˜í•˜ì§€ ì•Šìœ¼ì…¨ë‹¤ë©´, [ì´ì „ ê¸€](https://si.mpli.st/dev/2020-01-01-easy-k8s-with-k3s/)ì„ ì°¸ê³ í•˜ì…”ì„œ ì‰½ê²Œ í´ëŸ¬ìŠ¤í„°ë¥¼ ë§Œë“¤ê³  ëŒì•„ì™€ ì£¼ì„¸ìš”.

### ê°„ë‹¨í•œ ì›¹ ì„œë¹„ìŠ¤ ì‹¤í–‰

Kubernetesì—ì„œ ì›¹ ì„œë¹„ìŠ¤ë¥¼ ëŒë¦¬ê¸° ìœ„í•´ì„œëŠ” í¬ê²Œ Deployment, Service, Ingressë¼ëŠ” ì„¸ ì¢…ë¥˜ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ í™œìš©í•©ë‹ˆë‹¤. ì´ ì„¸ ê°€ì§€ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•´ì„œëŠ” ë‹¤ìŒì— ìì„¸í•˜ê²Œ ë‹¤ë£¨ê¸°ë¡œ í•˜ê³ , ìš°ì„  ì´ë¯¸ ë§Œë“¤ì–´ì§„ ì˜ˆì œ ì„œë¹„ìŠ¤ë¥¼ í™œìš©í•˜ë„ë¡ í•˜ì£ .

{{< figure src="https://simplist.cdn.sapbox.me/2020-03-01-k3s-https/inspekt-example.png" title="Host, Pod ì •ë³´ë¥¼ ë³´ì—¬ì£¼ëŠ” Inspekt ì„œë¹„ìŠ¤" >}}

[Inspekt](https://github.com/premist/inspekt)ëŠ” ì œê°€ ê°„ë‹¨í•˜ê²Œ ë§Œë“ , Kubernetesì— ì‹œí—˜ ì‚¼ì•„ ì˜¬ë¦¬ê¸° ì¢‹ì€ ì›¹ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. Kubernetesì˜ [Downward API](https://kubernetes.io/docs/tasks/inject-data-application/environment-variable-expose-pod-information/#the-downward-api)ë¥¼ ì´ìš©í•˜ì—¬ í˜„ì¬ êµ¬ë™ë˜ëŠ” í™˜ê²½ì— ëŒ€í•œ ëª‡ ê°€ì§€ ì •ë³´ë¥¼ ë³´ì—¬ì£¼ëŠ”ë°ìš”, ë””ë²„ê·¸ ë° í…ŒìŠ¤íŠ¸ë¥¼ í•  ë•Œ ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Inspektë¥¼ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì´ìš©í•´ í´ëŸ¬ìŠ¤í„°ì— ì˜¬ë ¤ë´…ì‹œë‹¤. `-k`ëŠ” [Kustomize](https://kustomize.io)ë¥¼ ì´ìš©í•´ ì ìš©í•˜ë¼ëŠ” ìŠ¤ìœ„ì¹˜ì…ë‹ˆë‹¤.

```bash
$ kubectl apply -k github.com/premist/inspekt 
```

![Kustomizeë¥¼ ì´ìš©í•´ inspekt ì„¤ì • ë°˜ì˜](https://simplist.cdn.sapbox.me/2020-03-01-k3s-https/inspekt-apply-k.png)

ì •ìƒì ìœ¼ë¡œ Deploymentì™€ Serviceê°€ ìƒì„±ë˜ì—ˆìœ¼ë©´, ì•„ë˜ ëª…ë ¹ì–´ë¡œ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
# Deployment ìƒíƒœ í™•ì¸
$ kubectl describe deployment inspekt

# Service ìƒíƒœ í™•ì¸
$ kubectl describe service inspekt
```

![Deploymentê°€ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆë‹¤](https://simplist.cdn.sapbox.me/2020-03-01-k3s-https/inspekt-describe-deployment-inspekt.png)

ì´ì œ ì›¹ ì„œë¹„ìŠ¤ê°€ ëŒì•„ê°€ê³  ìˆì§€ë§Œ, ì•„ì§ Ingressë¥¼ í†µí•´ ì™¸ë¶€ë¡œ ë…¸ì¶œë˜ì§€ëŠ” ì•Šì•˜ê¸° ë•Œë¬¸ì— ì§ì ‘ ì ‘ì†ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. [kubectl port-forward](https://kubectl.docs.kubernetes.io/pages/container_debugging/port_forward_to_pods.html) ëª…ë ¹ì–´ë¥¼ ì´ìš©í•´ì„œ ë¡œì»¬ì—ì„œ ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ í¬íŠ¸ í¬ì›Œë”©ì„ ì„¤ì •í•´ë´…ì‹œë‹¤.

```bash
# ì›ê²©ì§€ í¬íŠ¸ 8000ë¥¼ ë¡œì»¬ í¬íŠ¸ 9000ë¡œ í¬ì›Œë”©
$ kubectl port-forward deployment/inspekt-deployment 9000:8000
```

![í¬íŠ¸ í¬ì›Œë”© ì„¤ì •](https://simplist.cdn.sapbox.me/2020-03-01-k3s-https/kubectl-port-forward.png)

í¬íŠ¸ í¬ì›Œë”©ì„ ì™„ë£Œí•˜ì˜€ë‹¤ë©´, ë¸Œë¼ìš°ì €ì—ì„œ inspekt í™”ë©´ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!

![Inspekt ì›¹ í˜ì´ì§€](https://simplist.cdn.sapbox.me/2020-03-01-k3s-https/inspekt-port-forwarded.png)


### cert-managerë¡œ Letâ€™s Encrypt ì„¤ì •í•˜ê¸°

ì„œë¹„ìŠ¤ë¥¼ ì™¸ë¶€ì— ë…¸ì¶œí•˜ê¸° ì „ì—, HTTPS ì—°ê²°ì„ ìœ„í•´ ì¸ì¦ì„œë¥¼ ë°œê¸‰ë°›ì•„ì•¼ í•©ë‹ˆë‹¤. SSL/TLS ì¸ì¦ì„œë¥¼ ì§ì ‘ êµ¬ì…í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ë„ ìˆì§€ë§Œ, [Letâ€™s Encrypt](https://letsencrypt.org)ë¥¼ ì‚¬ìš©í•˜ëŠ” ì¸ì¦ì„œ ê´€ë¦¬ìì¸ [cert-manager](https://cert-manager.io)ë¥¼ ì‚¬ìš©í•˜ë©´ ë¬´ë£Œë¡œ ì¸ì¦ì„œ ë°œê¸‰ì´ ê°€ëŠ¥í•˜ê³  ê°±ì‹  ë˜í•œ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì¤ë‹ˆë‹¤.

ë‹¤ìŒ ë‘ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ ì„¤ì¹˜ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
# cert-managerê°€ ì‚¬ìš©í•  namespace ìƒì„±
$ kubectl create namespace cert-manager

# cert-managerê°€ ì‚¬ìš©í•˜ëŠ” êµ¬ì„±ìš”ì†Œ(CRD, ServiceAccount ë“±) ì„¤ì¹˜
$ kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v0.13.1/cert-manager.yaml
```

ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìœ¼ë©´ cert-managerê°€ Letâ€™s Encryptë¥¼ ì´ìš©í•˜ë„ë¡ ì„¤ì •ì„ í•´ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤. ë¡œì»¬ì— `letsencrypt.yaml` ì´ë¼ëŠ” íŒŒì¼ì„ ë§Œë“¤ê³  ì•„ë˜ ë‚´ìš©ì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”. ì˜ˆì œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ìì‹ ì˜ ì´ë©”ì¼ë¡œ ë³€ê²½í•˜ê³ , ì €ì¥í•©ë‹ˆë‹¤.

```yaml
apiVersion: cert-manager.io/v1alpha2
kind: ClusterIssuer
metadata:
  name: letsencrypt
spec:
  acme:
    # ìì‹ ì˜ ì´ë©”ì¼ ì£¼ì†Œ ì…ë ¥
    email: user@example.com
    server: https://acme-v02.api.letsencrypt.org/directory
    privateKeySecretRef:
      name: letsencrypt-account-key
    # ì›¹ ì„œë²„ë¥¼ ì´ìš©í•˜ì—¬ ê²€ì¦ì„ ì§„í–‰í•˜ëŠ” http01 solver ì‚¬ìš© 
    solvers:
    - http01:
        # k3sì˜ ê¸°ë³¸ Ingress ì»¨íŠ¸ë¡¤ëŸ¬ì¸ traefikì„ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •
        ingress:
          class: traefik
```

ë°©ê¸ˆ ë§Œë“  yamlì„ í´ëŸ¬ìŠ¤í„°ì— ì ìš©í•˜ëŠ” ê²ƒìœ¼ë¡œ Letâ€™s Encrypt ì‚¬ìš© ì¤€ë¹„ê°€ ì™„ë£Œë©ë‹ˆë‹¤.

```bash
$ kubectl apply -f letsencrypt.yaml
```

### inspekt ì›¹ ì„œë¹„ìŠ¤ì— Ingress ì—°ê²°í•˜ê¸°

ì´ì œ inspekt ì›¹ ì„œë¹„ìŠ¤ë¥¼ ì™¸ë¶€ì— ë…¸ì¶œí•  ì¤€ë¹„ê°€ ëª¨ë‘ ëë‚¬ìŠµë‹ˆë‹¤! ì¸ì¦ì„œ ë°œê¸‰ì„ ìœ„í•´ì„œëŠ” ì˜¬ë°”ë¥¸ ë„ë©”ì¸ì´ ì—°ê²°ë˜ì–´ ìˆì–´ì•¼ í•˜ëŠ”ë°ìš”, DNS ì„œë¹„ìŠ¤ì— ë“¤ì–´ê°€ì„œ í´ëŸ¬ìŠ¤í„°ì˜ IPë¥¼ ì…ë ¥í•´ì¤ë‹ˆë‹¤.

![DNS ì„¤ì •](https://simplist.cdn.sapbox.me/2020-03-01-k3s-https/dns-connect.png)

ë‹¤ìŒìœ¼ë¡œ Ingress ì„¤ì • íŒŒì¼ì„ ì‘ì„±í•´ì¤ë‹ˆë‹¤. ë¡œì»¬ì— `ingress.yaml` ì´ë¼ëŠ” íŒŒì¼ì„ ë§Œë“¤ê³ , ì•„ë˜ ë‚´ìš©ì„ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”. `spec.tls.hosts` ì— ì•ì—ì„œ ì„¤ì •í•œ ë„ë©”ì¸ì„ ì…ë ¥í•´ì£¼ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.

```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: inspekt
  annotations:
    kubernetes.io/ingress.class: "traefik"
    cert-manager.io/cluster-issuer: "letsencrypt"
spec:
  tls:
  - hosts:
    - <ì—¬ê¸°ì— ì„¤ì •í•œ ë„ë©”ì¸ ì…ë ¥>
    secretName: inspekt-tls
  rules:
  - http:
      paths:
      - path: /
        backend:
          serviceName: inspekt
          servicePort: http
```

ë°©ê¸ˆ ìƒì„±í•œ íŒŒì¼ì„ kubectlë¡œ ì ìš©í•´ì¤ì‹œë‹¤.

![Ingress ìƒì„±](https://simplist.cdn.sapbox.me/2020-03-01-k3s-https/ingress-apply.png)

ìœ„ Ingressë¥¼ ì ìš©í•˜ë©´ ë³´ì´ì§€ ì•ŠëŠ” ê³³ì—ì„œ ì—¬ëŸ¬ ê°€ì§€ ì¼ì´ ì¼ì–´ë‚˜ëŠ”ë°, ê·¸ ì¤‘ ëª‡ ê°€ì§€ë¥¼ ì¶”ë ¤ë³´ìë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- k3sì˜ ê¸°ë³¸ Ingress ì»¨íŠ¸ë¡¤ëŸ¬ì¸ [traefik](https://docs.traefik.io)ì´ ì£¼ì–´ì§„ ê·œì¹™ì— ë§ê²Œ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ë¼ìš°íŒ… ì„¤ì •ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
- `spec.tls.hosts` ì— ì„¤ì •í•œ ë„ë©”ì¸ì— ëŒ€í•œ ê²€ì¦ì„ ì§„í–‰í•©ë‹ˆë‹¤. ê²€ì¦ì— í•„ìš”í•œ ì›¹ ì„œë²„ë¥¼ ì‹¤í–‰í•˜ê³ , ë¼ìš°íŒ… ì„¤ì •ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
- ì¸ì¦ì„œê°€ ë°œí–‰ë˜ë©´ `spec.tls.secretName`ì—ì„œ ì§€ì •í•œ [secret](https://kubernetes.io/docs/concepts/configuration/secret/)ì— ì €ì¥í•©ë‹ˆë‹¤. secretì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´, ìƒˆë¡œ ë§Œë“¤ê³  ì €ì¥í•©ë‹ˆë‹¤.

Kubernetesì˜ ì´ë²¤íŠ¸ ë¡œê·¸ë¥¼ ë³´ë©´, ì–´ë–¤ ì¼ì´ ì¼ì–´ë‚˜ëŠ”ì§€ ì¡°ê¸ˆ ë” ìì„¸í•˜ê²Œ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
# ìµœê·¼ ì´ë²¤íŠ¸ ë³´ê¸°
kubectl get events --sort-by=.metadata.creationTimestamp
```

![ì¸ì¦ì„œ ë°œê¸‰ì— ê´€í•œ ì—¬ëŸ¬ ì´ë²¤íŠ¸](https://simplist.cdn.sapbox.me/2020-03-01-k3s-https/kubectl-events.png)

ì—¬ê¸°ê¹Œì§€ ëª¨ë“  ê³¼ì •ì„ ì„±ê³µì ìœ¼ë¡œ ì§„í–‰í•˜ì…¨ë‹¤ë©´, ì§€ì •í•œ ë„ë©”ì¸ì—ì„œ inspekt ì„œë¹„ìŠ¤ì— ì ‘ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸ‰

{{<figure src="https://simplist.cdn.sapbox.me/2020-03-01-k3s-https/inspekt-with-https-and-domain.png" title="HTTPSë¡œ ì ‘ì†ì´ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤" >}}


### ë§ˆì¹˜ë©°

ì´ë ‡ê²Œ ê°„ë‹¨í•œ ì›¹ ì„œë¹„ìŠ¤ë¥¼ í´ëŸ¬ìŠ¤í„°ì— ì¶”ê°€í•˜ê³ , Letâ€™s Encrypt ì‚¬ìš©ì„ ì„¤ì •í•˜ê³ , Ingressë¥¼ ë§Œë“¤ì–´ ì›¹ ì„œë¹„ìŠ¤ë¥¼ ìœ„í•œ Letâ€™s Encrypt ì¸ì¦ì„œë¥¼ ë°œê¸‰ë°›ëŠ” ê³¼ì •ê¹Œì§€ ëª¨ë‘ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤. ê¸°ì¡´ì˜ ì„œë²„ ì„¤ì • ê³¼ì •ê³¼ëŠ” ë‹¤ë¥¸ ë°©ì‹ì— ìƒì†Œí•  ìˆ˜ ìˆì§€ë§Œ, ì•ìœ¼ë¡œ ë°°í¬í•˜ëŠ” ëª¨ë“  ì›¹ ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì¸ì¦ì„œë¥¼ ìë™ìœ¼ë¡œ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆë‹¤ëŠ” ì ì´ ê½¤ë‚˜ ë§¤ë ¥ì ì…ë‹ˆë‹¤. ê·¸ë¦¬ê³ , ì›í•˜ëŠ” ìƒíƒœë¥¼ ê¸°ìˆ í•˜ë¯€ë¡œì¨ ì„¤ì •ì„ í•  ìˆ˜ ìˆëŠ”, ì„œë²„ì˜ ì„ ì–¸ì  ê´€ë¦¬(declarative management)ë¥¼ í•  ìˆ˜ ìˆë‹¤ëŠ” ì ì—ì„œ ì˜¤ëŠ” ê´€ë¦¬ì˜ ìš©ì´í•¨ ë˜í•œ ë¹¼ë†“ì„ ìˆ˜ ì—†ì„ ê²ƒì…ë‹ˆë‹¤.

ì´ ê°€ì´ë“œë¥¼ ë³´ê¸° ì „ì— Kubernetesë¥¼ ì‚¬ìš©í•´ë³´ì§€ ì•Šì€ ë¶„ì´ë¼ë©´ Deployment, Ingressì™€ ê°™ì€ ì—¬ëŸ¬ ê°œë…ì´ ì•„ì§ ì˜ ì™€ë‹¿ì§€ ì•Šìœ¼ì‹¤ í…ë°, ì´ì— ëŒ€í•œ ì„¤ëª…ë„ ì¡°ë§Œê°„ ë‹¤ë£° ê¸°íšŒê°€ ìˆìœ¼ë©´ ì¢‹ê² ë„¤ìš”. ì•ìœ¼ë¡œë„ k3s ê´€ë ¨ ê¸€ì„ ëª‡ í¸ ë” ì˜¬ë¦¬ë ¤ê³  í•©ë‹ˆë‹¤. ê¶ê¸ˆí•˜ì‹  ì£¼ì œê°€ ìˆìœ¼ë©´ [ì´ë©”ì¼ì´ë‚˜ íŠ¸ìœ„í„° ë“±ì˜ ì±„ë„](https://premi.st/)ë¡œ ì•Œë ¤ì£¼ì„¸ìš”.
